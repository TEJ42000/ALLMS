<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <link rel="icon" type="image/svg+xml" href="/static/images/favicon.svg">
    <link rel="stylesheet" href="/static/css/styles.css">
    <link rel="stylesheet" href="/static/css/quiz-enhancements.css">
    <link rel="stylesheet" href="/static/css/quiz-answer-enhancements.css">
    <link rel="stylesheet" href="/static/css/quiz-navigation-controls.css">
    <link rel="stylesheet" href="/static/css/quiz-results-display.css">
    <link rel="stylesheet" href="/static/css/quiz-accessibility.css">
    <link rel="stylesheet" href="/static/css/quiz-mobile.css">
    <link rel="stylesheet" href="/static/css/gamification.css">
    <!-- EasyMDE Markdown Editor -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/easymde@2.18.0/dist/easymde.min.css">
    <script src="https://cdn.jsdelivr.net/npm/easymde@2.18.0/dist/easymde.min.js"></script>
    <!-- Markdown and Mermaid rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked@12.0.0/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    <!-- Confetti for badge animations -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <!-- Course Context -->
    <script>
        // Store course context for JavaScript access
        window.COURSE_CONTEXT = {
            courseId: {{ course_id|tojson if course_id else 'null' }},
            courseName: {{ course_name|tojson if course_name else '"LLS"' }},
            {% if course %}
            course: {
                id: {{ course.id|tojson }},
                name: {{ course.name|tojson }},
                program: {{ course.program|tojson if course.program else 'null' }},
                institution: {{ course.institution|tojson if course.institution else 'null' }},
                academicYear: {{ course.academicYear|tojson if course.academicYear else 'null' }},
                ects: {{ course.ects if course.ects else 0 }}
            }
            {% else %}
            course: null
            {% endif %}
        };
    </script>
</head>
<body>
    <div class="container">
        <header class="nav-header">
            <div class="header-top">
                <h1 class="nav-title">âš–ï¸ {{ course_name if course_name else 'LLS' }} Study Portal</h1>
                <div style="display: flex; align-items: center; gap: 1rem;">
                    {% if course_id %}
                    <div class="course-badge">
                        <span class="course-badge-label">Course:</span>
                        <span class="course-badge-id">{{ course_id }}</span>
                        <a href="/" class="change-course-link" title="Change Course">ğŸ”„</a>
                    </div>
                    {% endif %}
                    {% if user %}
                    {% include "partials/user_header.html" %}
                    {% endif %}
                </div>
            </div>
            <div class="nav-tabs">
                <button class="nav-tab active" data-tab="dashboard">ğŸ“Š Dashboard</button>
                <button class="nav-tab" data-tab="weeks">ğŸ“… Weeks</button>
                <button class="nav-tab" data-tab="badges">ğŸ† Badges</button>
                <button class="nav-tab" data-tab="upload">ğŸ“¤ Upload</button>
                <button class="nav-tab" data-tab="tutor">ğŸ¤– AI Tutor</button>
                <button class="nav-tab" data-tab="assessment">ğŸ“ Assessment</button>
                <button class="nav-tab" data-tab="quiz">ğŸ¯ Quiz</button>
                <button class="nav-tab" data-tab="flashcards">ğŸ—‚ï¸ Flashcards</button>
                <button class="nav-tab" data-tab="study">ğŸ“š Study Guide</button>
            </div>
        </header>
        <main id="main-content">
            <section id="dashboard-section" class="section active">
                <div class="dashboard-header">
                    <h2>Welcome Back! ğŸ“</h2>
                    <div class="exam-info">
                        <p>Your personalized study dashboard{% if course %} for {{ course.name }}{% endif %}</p>
                        <p class="exam-date">Track your progress and master {% if course_name %}{{ course_name }}{% else %}LLS{% endif %} topics</p>
                    </div>
                </div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">ğŸ†</div>
                        <div class="stat-value" id="stat-points">0</div>
                        <div class="stat-label">Total Points</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">ğŸ”¥</div>
                        <div class="stat-value" id="stat-streak">0</div>
                        <div class="stat-label">Day Streak</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">ğŸ“š</div>
                        <div class="stat-value" id="stat-topics">0/5</div>
                        <div class="stat-label">Topics Studied</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">âœ…</div>
                        <div class="stat-value" id="stat-quizzes">0</div>
                        <div class="stat-label">Quizzes Completed</div>
                    </div>
                </div>
                <h3 class="section-subtitle">ğŸ“– Course Weeks</h3>
                <div id="overview-weeks-grid" class="topics-grid">
                    <div class="loading-placeholder">Loading course weeks...</div>
                </div>
            </section>
            <section id="badges-section" class="section">
                <div class="badges-header">
                    <h2 class="section-title">ğŸ† Badge Collection</h2>
                    <p class="section-description">Earn badges by completing challenges and reaching milestones</p>
                </div>

                <!-- Earned Badges -->
                <div class="badges-category">
                    <h3 class="section-subtitle">âœ¨ Your Badges</h3>
                    <div id="earned-badges-grid" class="badges-grid">
                        <div class="loading-placeholder">Loading your badges...</div>
                    </div>
                </div>

                <!-- Available Badges -->
                <div class="badges-category">
                    <h3 class="section-subtitle">ğŸ”’ Available Badges</h3>
                    <p class="badges-category-description">Complete these challenges to earn more badges!</p>
                    <div id="available-badges-grid" class="badges-grid">
                        <div class="loading-placeholder">Loading available badges...</div>
                    </div>
                </div>
            </section>

            <!-- Upload Section - MVP Feature -->
            <section id="upload-section" class="section">
                <h2 class="section-title">ğŸ“¤ Upload Course Materials</h2>
                <p class="section-description">Upload your lecture slides, notes, or textbook chapters for AI analysis</p>

                <div id="upload-container">
                    <!-- Upload Dropzone -->
                    <div id="upload-dropzone" class="upload-dropzone">
                        <div class="dropzone-content">
                            <span class="dropzone-icon">ğŸ“</span>
                            <p class="dropzone-text">Drag & drop files here</p>
                            <p class="dropzone-hint">or click to browse</p>
                            <p class="dropzone-formats">Supported: PDF, DOCX, PPTX, TXT, MD, HTML (max 25MB)</p>
                        </div>
                        <input type="file" id="file-input" style="display: none;" accept=".pdf,.docx,.pptx,.txt,.md,.html">
                    </div>

                    <!-- Upload Progress -->
                    <div id="upload-progress" class="upload-progress" style="display: none;">
                        <div class="progress-item">
                            <span class="progress-filename"></span>
                            <span class="progress-status">Uploading...</span>
                        </div>
                    </div>

                    <!-- Upload Results -->
                    <div id="upload-results" class="upload-results" style="display: none;">
                        <h3 class="results-title">ğŸ“Š Analysis Results</h3>
                        <div id="analysis-content"></div>
                        <div class="upload-actions">
                            <button id="generate-quiz-btn" class="btn btn-primary">ğŸ¯ Generate Quiz</button>
                            <button id="generate-flashcards-btn" class="btn btn-secondary">ğŸ—‚ï¸ Generate Flashcards</button>
                            <button id="upload-another-btn" class="btn btn-secondary">ğŸ“¤ Upload Another</button>
                        </div>
                    </div>

                    <!-- Recent Uploads -->
                    <div id="recent-uploads" class="recent-uploads">
                        <h3>ğŸ“‚ Recent Uploads</h3>
                        <div id="recent-uploads-list" class="recent-uploads-list">
                            <p class="loading-text">Loading recent uploads...</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Weekly Content Section -->
            <section id="weeks-section" class="section">
                <h2 class="section-title">ğŸ“š Course Content by Week</h2>
                <p class="section-description">Explore weekly topics, study materials, and get AI-powered help</p>

                <!-- Part Selector (for courses with parts like Criminal Law) -->
                <div id="part-selector" class="part-selector" style="display: none;" role="tablist" aria-label="Course part selector">
                    <div class="part-tabs">
                        <button class="part-tab active" data-part="A" role="tab" aria-selected="true" aria-controls="weeks-grid" id="part-a-tab">Part A</button>
                        <button class="part-tab" data-part="B" role="tab" aria-selected="false" aria-controls="weeks-grid" id="part-b-tab">Part B</button>
                        <button class="part-tab" data-part="mixed" role="tab" aria-selected="false" aria-controls="weeks-grid" id="part-mixed-tab">Mixed</button>
                    </div>
                    <!-- ARIA live region for screen reader announcements -->
                    <div id="part-filter-status" class="visually-hidden" role="status" aria-live="polite" aria-atomic="true"></div>
                </div>

                <!-- Week Grid -->
                <div class="week-grid" id="weeks-grid">
                    <!-- Week cards will be dynamically inserted here by weeks.js -->
                    <div class="loading-placeholder">Loading weekly content...</div>
                </div>
            </section>

            <section id="tutor-section" class="section">
                <h2 class="section-title">ğŸ¤– AI Tutor</h2>
                <p class="section-description">Ask questions about any LLS topic and get detailed explanations</p>
                <div class="chat-container">
                    <div id="chat-messages" class="chat-messages">
                        <!-- Welcome message -->
                        <div class="message-wrapper assistant">
                            <div class="message-avatar">ğŸ¤–</div>
                            <div class="message">
                                <p><strong>Hello!</strong> I'm your AI study assistant for this course.</p>
                                <p>Select a topic from the dropdown below and ask me anything about the course material. I can help you understand concepts, explain cases, and prepare for assessments.</p>
                            </div>
                        </div>
                    </div>
                    <div class="chat-input-area">
                        <label for="context-select" class="visually-hidden">Select Topic Context</label>
                        <select id="context-select" class="form-select" aria-label="Select topic context for your question">
                            {% if topics %}
                            {% for topic in topics %}
                            <option value="{{ topic.name }}">Week {{ topic.weekNumber }}: {{ topic.name }}</option>
                            {% endfor %}
                            {% else %}
                            <option value="General">General</option>
                            {% endif %}
                        </select>
                        <div class="chat-input-row">
                            <label for="tutor-input" class="visually-hidden">Your question for the AI Tutor</label>
                            <textarea id="tutor-input" placeholder="Ask about concepts, cases, frameworks..." rows="1" aria-label="Enter your question for the AI Tutor"></textarea>
                            <button id="ask-btn" class="btn btn-primary">Ask</button>
                        </div>
                    </div>
                </div>
            </section>
            <section id="assessment-section" class="section">
                <h2 class="section-title">ğŸ“ Essay Assessment</h2>
                <p class="section-description">Practice essay-style exam questions with AI-powered grading</p>

                <!-- Assessment Tabs -->
                <div class="assessment-tabs">
                    <button class="assessment-tab active" data-assessment-tab="new">âœ¨ New Essay</button>
                    <button class="assessment-tab" data-assessment-tab="history">ğŸ“š My History</button>
                </div>

                <!-- New Essay Tab -->
                <div id="new-essay-tab" class="assessment-tab-content">
                    <!-- Essay Question View (hidden until question generated) -->
                    <div id="essay-question-view" style="display: none;">
                        <div class="essay-question-card">
                            <div class="essay-question-header">
                                <span class="essay-topic-badge" id="essay-topic-badge"></span>
                                <span class="essay-expected">Expected: 3-7 paragraphs</span>
                            </div>
                            <h3 id="essay-question-text" class="essay-question-text"></h3>
                            <div id="essay-key-concepts" class="essay-key-concepts"></div>
                            <div id="essay-guidance" class="essay-guidance"></div>
                        </div>
                        <div class="form-group">
                            <label for="essay-answer">Your Essay Answer</label>
                            <textarea id="essay-answer" placeholder="Write your essay answer here (3-7 paragraphs recommended)..." rows="12"></textarea>
                            <div class="essay-word-count">Words: <span id="essay-word-count">0</span></div>
                        </div>
                        <div class="essay-actions">
                            <button id="submit-essay-btn" class="btn btn-primary">Submit for Evaluation</button>
                            <button id="new-question-btn" class="btn btn-secondary">Generate New Question</button>
                        </div>
                        <div id="essay-result" class="result-box"></div>
                    </div>

                    <!-- Generate Question View -->
                    <div id="generate-question-view">
                        <div class="essay-intro-card">
                            <h3>ğŸ“ Practice Essay Questions</h3>
                            <p>Generate exam-style essay questions and get detailed AI feedback on your answers.</p>
                            <ul class="essay-features">
                                <li>âœ… Questions similar to actual exam questions</li>
                                <li>âœ… AI evaluation with grade (1-10)</li>
                                <li>âœ… Detailed feedback on strengths and improvements</li>
                                <li>âœ… Save and track your progress</li>
                            </ul>
                        </div>
                        <div class="form-group">
                            <label for="essay-topic-select">Select Topic</label>
                            <select id="essay-topic-select" class="form-select">
                                {% if topics %}
                                <!-- Comprehensive Practice Options -->
                                <option value="ğŸ“š All Weeks - Comprehensive Practice">ğŸ“š All Weeks - Comprehensive Practice</option>
                                <option value="âš–ï¸ Part A (Weeks 1-6) - Substantive Criminal Law">âš–ï¸ Part A (Weeks 1-6) - Substantive Criminal Law</option>
                                <option value="ğŸ›ï¸ Part B (Weeks 7-12) - Criminal Procedure">ğŸ›ï¸ Part B (Weeks 7-12) - Criminal Procedure</option>
                                <option disabled>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</option>
                                <!-- Individual Week Topics -->
                                {% for topic in topics %}
                                <option value="{{ topic.name }}">Week {{ topic.weekNumber }}: {{ topic.name }}</option>
                                {% endfor %}
                                {% else %}
                                <option value="General">General</option>
                                {% endif %}
                            </select>
                        </div>
                        <button id="generate-essay-btn" class="btn btn-primary btn-large">ğŸ“ Generate Essay Question</button>
                    </div>
                </div>

                <!-- History Tab -->
                <div id="essay-history-tab" class="assessment-tab-content" style="display: none;">
                    <div id="essay-history-list" class="essay-history-list">
                        <p class="loading-text">Loading your assessment history...</p>
                    </div>
                </div>
            </section>
            <section id="quiz-section" class="section">
                <h2 class="section-title">ğŸ¯ Interactive Quiz</h2>
                <p class="section-description">Test your knowledge with practice questions</p>
                <div id="quiz-container">
                    <!-- Quiz Selection View -->
                    <div id="quiz-selection-view">
                        <div class="quiz-tabs">
                            <button class="quiz-tab active" data-quiz-tab="saved">ğŸ“š Saved Quizzes</button>
                            <button class="quiz-tab" data-quiz-tab="new">âœ¨ New Quiz</button>
                            <button class="quiz-tab" data-quiz-tab="history">ğŸ“Š My History</button>
                        </div>

                        <!-- Saved Quizzes Tab -->
                        <div id="saved-quizzes-tab" class="quiz-tab-content active">
                            <div id="saved-quizzes-list" class="saved-quizzes-list">
                                <p class="loading-text">Loading saved quizzes...</p>
                            </div>
                        </div>

                        <!-- New Quiz Tab -->
                        <div id="new-quiz-tab" class="quiz-tab-content hidden">
                            <div class="quiz-controls">
                                <div class="form-group">
                                    <label for="quiz-topic-select">Select Topic</label>
                                    <select id="quiz-topic-select" class="form-select">
                                        <option value="all">All Topics</option>
                                        {% if topics %}
                                        {% for topic in topics %}
                                        <option value="week-{{ topic.weekNumber }}">Week {{ topic.weekNumber }}: {{ topic.name }}</option>
                                        {% endfor %}
                                        {% endif %}
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="quiz-difficulty-select">Difficulty</label>
                                    <select id="quiz-difficulty-select" class="form-select">
                                        <option value="easy">Easy</option>
                                        <option value="medium" selected>Medium</option>
                                        <option value="hard">Hard</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="quiz-num-questions">Number of Questions</label>
                                    <select id="quiz-num-questions" class="form-select">
                                        <option value="5">5 Questions</option>
                                        <option value="10" selected>10 Questions</option>
                                        <option value="15">15 Questions</option>
                                        <option value="20">20 Questions</option>
                                    </select>
                                </div>
                                <button id="start-quiz-btn" class="btn btn-primary">Generate New Quiz</button>
                            </div>
                        </div>

                        <!-- History Tab -->
                        <div id="history-tab" class="quiz-tab-content hidden">
                            <div id="quiz-history-list" class="quiz-history-list">
                                <p class="loading-text">Loading quiz history...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Quiz Content (hidden until quiz starts) -->
                    <div id="quiz-content" class="quiz-content hidden">
                        <div class="quiz-header">
                            <button id="back-to-quizzes-btn" class="btn btn-secondary btn-small">â† Back to Quizzes</button>
                            <div class="quiz-progress"><span id="quiz-current">1</span> / <span id="quiz-total">10</span></div>
                            <div class="quiz-score">Score: <span id="quiz-score">0</span></div>
                        </div>
                        <div class="quiz-main-content">
                            <div id="quiz-question-container"></div>
                            <div id="quiz-nav-sidebar-container"></div>
                        </div>
                    </div>
                </div>
            </section>
            <section id="flashcards-section" class="section">
                <h2 class="section-title">ğŸ—‚ï¸ Flashcards</h2>
                <p class="section-description">Memorize key concepts and cases from your course materials</p>
                <div id="flashcards-container">
                    <div class="flashcard-controls">
                        <div class="flashcard-stats">
                            <span>Cards Mastered: <strong id="cards-mastered">0</strong> / <strong id="cards-total">0</strong></span>
                        </div>
                        <button id="load-flashcards-btn" class="btn btn-primary">
                            ğŸ”„ Generate New Flashcards
                        </button>
                    </div>
                    <div class="flashcard-display">
                        <div id="flashcard" class="flashcard" role="region" aria-live="polite" aria-label="Flashcard display">
                            <div class="flashcard-inner">
                                <div class="flashcard-front"><p id="flashcard-question">Loading flashcards...</p></div>
                                <div class="flashcard-back"><p id="flashcard-answer"></p></div>
                            </div>
                        </div>
                        <div class="flashcard-actions">
                            <button id="prev-card-btn" class="btn btn-secondary" aria-label="Go to previous flashcard">â† Previous</button>
                            <button id="flip-card-btn" class="btn btn-primary" aria-label="Flip flashcard to reveal answer">Flip Card</button>
                            <button id="next-card-btn" class="btn btn-secondary" aria-label="Go to next flashcard">Next â†’</button>
                        </div>
                        <div class="flashcard-knowledge">
                            <button id="know-btn" class="btn btn-success" aria-label="Mark card as known">âœ“ I Know This</button>
                            <button id="study-btn" class="btn btn-warning" aria-label="Mark card for further study">â†» Need to Study</button>
                        </div>
                    </div>
                </div>
            </section>
            <section id="study-section" class="section">
                <h2 class="section-title">ğŸ“š Study Guide</h2>
                <p class="section-description">Generate and view comprehensive study guides from course materials</p>

                <!-- Study Guide Sub-tabs -->
                <div class="quiz-sub-tabs">
                    <button class="quiz-sub-tab active" data-study-tab="saved-guides">ğŸ“‚ Saved Guides</button>
                    <button class="quiz-sub-tab" data-study-tab="new-guide">âœ¨ Generate New</button>
                </div>

                <!-- Saved Guides Tab -->
                <div id="saved-guides-tab" class="quiz-tab-content active">
                    <div id="study-guides-list" class="saved-quizzes-list">
                        <p class="loading-text">Loading saved study guides...</p>
                    </div>
                </div>

                <!-- Generate New Guide Tab -->
                <div id="new-guide-tab" class="quiz-tab-content" style="display: none;">
                    <div class="study-form">
                        <div class="form-group">
                            <label for="study-week-select">Week (optional):</label>
                            <select id="study-week-select" class="form-control">
                                <option value="">All Weeks</option>
                                {% if topics %}
                                {% for topic in topics %}
                                <option value="{{ topic.weekNumber }}" data-week="{{ topic.weekNumber }}">Week {{ topic.weekNumber }}: {{ topic.name }}</option>
                                {% endfor %}
                                {% endif %}
                            </select>
                            <button type="button" id="estimate-tokens-btn" class="btn btn-small btn-secondary" style="margin-left: 10px;">ğŸ“Š Estimate Tokens</button>
                        </div>
                        <button id="generate-study-btn" class="btn btn-primary">Generate Comprehensive Study Guide</button>
                    </div>

                    <!-- Collapsible Debug Panel -->
                    <details id="token-debug-panel" class="debug-panel" style="display: none;">
                        <summary>ğŸ”§ Token Estimation Details</summary>
                        <div id="token-debug-content" class="debug-content">
                            <!-- Populated by JavaScript -->
                        </div>
                    </details>
                </div>

                <!-- Study Guide Content Display -->
                <div id="study-result" class="study-guide-content result-box"></div>
            </section>
        </main>
        <div id="loading" class="loading hidden">
            <div class="spinner"></div>
            <p>Processing...</p>
        </div>
    </div>

    <!-- Week Study Notes Modal -->
    <div id="week-content-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="week-modal-title">Week Study Notes</h2>
                <button class="close-btn" onclick="closeWeekModal()">&times;</button>
            </div>
            <div class="modal-body" id="week-modal-body">
                <!-- Beautiful study notes loaded dynamically -->
            </div>
        </div>
    </div>

    <footer class="footer">
        <p>&copy; 2026 Cognitio Flow | University of Groningen | v{{ version }}</p>
    </footer>
    <!-- Load scripts in correct order: utils first, then dependencies, then features, then app -->
    <script src="/static/js/utils.js" defer></script>
    <script src="/static/js/activity-tracker.js" defer></script>
    <script src="/static/js/gamification-ui.js" defer></script>
    <script src="/static/js/gamification-animations.js" defer></script>
    <script src="/static/js/progress-visualizations.js" defer></script>
    <script src="/static/js/shareable-graphics.js" defer></script>
    <script src="/static/js/sound-control.js" defer></script>
    <script src="/static/js/onboarding-tour.js" defer></script>
    <script src="/static/js/quiz-display-enhancements.js" defer></script>
    <script src="/static/js/quiz-answer-enhancements.js" defer></script>
    <script src="/static/js/quiz-navigation-controls.js" defer></script>
    <script src="/static/js/quiz-results-display.js" defer></script>
    <script src="/static/js/quiz-accessibility.js" defer></script>
    <script src="/static/js/quiz-mobile.js" defer></script>
    <script src="/static/js/upload-mvp.js" defer></script>
    <script src="/static/js/weeks.js?v=16" defer></script>
    <script src="/static/js/app.js?v=16" defer></script>
</body>
</html>