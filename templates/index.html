<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <link rel="icon" type="image/svg+xml" href="/static/images/favicon.svg">
    <link rel="stylesheet" href="/static/css/styles.css">
    <!-- Markdown and Mermaid rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked@12.0.0/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    <!-- Course Context -->
    <script>
        // Store course context for JavaScript access
        window.COURSE_CONTEXT = {
            courseId: {{ course_id|tojson if course_id else 'null' }},
            courseName: {{ course_name|tojson if course_name else '"LLS"' }},
            {% if course %}
            course: {
                id: {{ course.id|tojson }},
                name: {{ course.name|tojson }},
                program: {{ course.program|tojson if course.program else 'null' }},
                institution: {{ course.institution|tojson if course.institution else 'null' }},
                academicYear: {{ course.academicYear|tojson if course.academicYear else 'null' }},
                ects: {{ course.ects if course.ects else 0 }}
            }
            {% else %}
            course: null
            {% endif %}
        };
    </script>
</head>
<body>
    <div class="container">
        <header class="nav-header">
            <div class="header-top">
                <h1 class="nav-title">‚öñÔ∏è {{ course_name if course_name else 'LLS' }} Study Portal</h1>
                <div style="display: flex; align-items: center; gap: 1rem;">
                    {% if course_id %}
                    <div class="course-badge">
                        <span class="course-badge-label">Course:</span>
                        <span class="course-badge-id">{{ course_id }}</span>
                        <a href="/" class="change-course-link" title="Change Course">üîÑ</a>
                    </div>
                    {% endif %}
                    {% if user %}
                    {% include "partials/user_header.html" %}
                    {% endif %}
                </div>
            </div>
            <div class="nav-tabs">
                <button class="nav-tab active" data-tab="dashboard">üìä Dashboard</button>
                <button class="nav-tab" data-tab="tutor">ü§ñ AI Tutor</button>
                <button class="nav-tab" data-tab="assessment">üìù Assessment</button>
                <button class="nav-tab" data-tab="quiz">üéØ Quiz</button>
                <button class="nav-tab" data-tab="flashcards">üóÇÔ∏è Flashcards</button>
                <button class="nav-tab" data-tab="study">üìö Study Guide</button>
            </div>
        </header>
        <main id="main-content">
            <section id="dashboard-section" class="section active">
                <div class="dashboard-header">
                    <h2>Welcome Back! üéì</h2>
                    <div class="exam-info">
                        <p>Your personalized study dashboard{% if course %} for {{ course.name }}{% endif %}</p>
                        <p class="exam-date">Track your progress and master {% if course_name %}{{ course_name }}{% else %}LLS{% endif %} topics</p>
                    </div>
                </div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">üèÜ</div>
                        <div class="stat-value" id="stat-points">0</div>
                        <div class="stat-label">Total Points</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üî•</div>
                        <div class="stat-value" id="stat-streak">0</div>
                        <div class="stat-label">Day Streak</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üìö</div>
                        <div class="stat-value" id="stat-topics">0/5</div>
                        <div class="stat-label">Topics Studied</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">‚úÖ</div>
                        <div class="stat-value" id="stat-quizzes">0</div>
                        <div class="stat-label">Quizzes Completed</div>
                    </div>
                </div>
                <h3 class="section-subtitle">üìñ Course Weeks</h3>
                <div id="weeks-grid" class="topics-grid">
                    <div class="loading-placeholder">Loading course weeks...</div>
                </div>
            </section>
            <section id="tutor-section" class="section">
                <h2 class="section-title">ü§ñ AI Tutor</h2>
                <p class="section-description">Ask questions about any LLS topic and get detailed explanations</p>
                <div class="chat-container">
                    <div id="chat-messages" class="chat-messages">
                        <!-- Welcome message -->
                        <div class="message-wrapper assistant">
                            <div class="message-avatar">ü§ñ</div>
                            <div class="message">
                                <p><strong>Hello!</strong> I'm your AI study assistant for this course.</p>
                                <p>Select a topic from the dropdown below and ask me anything about the course material. I can help you understand concepts, explain cases, and prepare for assessments.</p>
                            </div>
                        </div>
                    </div>
                    <div class="chat-input-area">
                        <label for="context-select" class="visually-hidden">Select Topic Context</label>
                        <select id="context-select" class="form-select" aria-label="Select topic context for your question">
                            {% if topics %}
                            {% for topic in topics %}
                            <option value="{{ topic.name }}">Week {{ topic.weekNumber }}: {{ topic.name }}</option>
                            {% endfor %}
                            {% else %}
                            <option value="General">General</option>
                            {% endif %}
                        </select>
                        <div class="chat-input-row">
                            <label for="tutor-input" class="visually-hidden">Your question for the AI Tutor</label>
                            <textarea id="tutor-input" placeholder="Ask about concepts, cases, frameworks..." rows="1" aria-label="Enter your question for the AI Tutor"></textarea>
                            <button id="ask-btn" class="btn btn-primary">Ask</button>
                        </div>
                    </div>
                </div>
            </section>
            <section id="assessment-section" class="section">
                <h2 class="section-title">üìù Assessment</h2>
                <p class="section-description">Get your answers graded with detailed AI feedback</p>
                <div class="assessment-form">
                    <div class="form-group">
                        <label for="assessment-topic">Topic</label>
                        <select id="assessment-topic" class="form-select">
                            {% if topics %}
                            {% for topic in topics %}
                            <option value="{{ topic.name }}">Week {{ topic.weekNumber }}: {{ topic.name }}</option>
                            {% endfor %}
                            {% else %}
                            <option value="General">General</option>
                            {% endif %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="assessment-question">Question (Optional)</label>
                        <textarea id="assessment-question" placeholder="Enter the question or prompt..." rows="2"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="assessment-answer">Your Answer</label>
                        <textarea id="assessment-answer" placeholder="Enter your answer here..." rows="8"></textarea>
                    </div>
                    <button id="assess-btn" class="btn btn-primary">Get Assessment</button>
                    <div id="assessment-result" class="result-box"></div>
                </div>
            </section>
            <section id="quiz-section" class="section">
                <h2 class="section-title">üéØ Interactive Quiz</h2>
                <p class="section-description">Test your knowledge with practice questions</p>
                <div id="quiz-container">
                    <!-- Quiz Selection View -->
                    <div id="quiz-selection-view">
                        <div class="quiz-tabs">
                            <button class="quiz-tab active" data-quiz-tab="saved">üìö Saved Quizzes</button>
                            <button class="quiz-tab" data-quiz-tab="new">‚ú® New Quiz</button>
                            <button class="quiz-tab" data-quiz-tab="history">üìä My History</button>
                        </div>

                        <!-- Saved Quizzes Tab -->
                        <div id="saved-quizzes-tab" class="quiz-tab-content active">
                            <div id="saved-quizzes-list" class="saved-quizzes-list">
                                <p class="loading-text">Loading saved quizzes...</p>
                            </div>
                        </div>

                        <!-- New Quiz Tab -->
                        <div id="new-quiz-tab" class="quiz-tab-content hidden">
                            <div class="quiz-controls">
                                <div class="form-group">
                                    <label for="quiz-topic-select">Select Topic</label>
                                    <select id="quiz-topic-select" class="form-select">
                                        <option value="all">All Topics</option>
                                        {% if topics %}
                                        {% for topic in topics %}
                                        <option value="week-{{ topic.weekNumber }}">Week {{ topic.weekNumber }}: {{ topic.name }}</option>
                                        {% endfor %}
                                        {% endif %}
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="quiz-difficulty-select">Difficulty</label>
                                    <select id="quiz-difficulty-select" class="form-select">
                                        <option value="easy">Easy</option>
                                        <option value="medium" selected>Medium</option>
                                        <option value="hard">Hard</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="quiz-num-questions">Number of Questions</label>
                                    <select id="quiz-num-questions" class="form-select">
                                        <option value="5">5 Questions</option>
                                        <option value="10" selected>10 Questions</option>
                                        <option value="15">15 Questions</option>
                                        <option value="20">20 Questions</option>
                                    </select>
                                </div>
                                <button id="start-quiz-btn" class="btn btn-primary">Generate New Quiz</button>
                            </div>
                        </div>

                        <!-- History Tab -->
                        <div id="history-tab" class="quiz-tab-content hidden">
                            <div id="quiz-history-list" class="quiz-history-list">
                                <p class="loading-text">Loading quiz history...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Quiz Content (hidden until quiz starts) -->
                    <div id="quiz-content" class="quiz-content hidden">
                        <div class="quiz-header">
                            <button id="back-to-quizzes-btn" class="btn btn-secondary btn-small">‚Üê Back to Quizzes</button>
                            <div class="quiz-progress"><span id="quiz-current">1</span> / <span id="quiz-total">10</span></div>
                            <div class="quiz-score">Score: <span id="quiz-score">0</span></div>
                        </div>
                        <div id="quiz-question-container"></div>
                    </div>
                </div>
            </section>
            <section id="flashcards-section" class="section">
                <h2 class="section-title">üóÇÔ∏è Flashcards</h2>
                <p class="section-description">Memorize key concepts and cases</p>
                <div id="flashcards-container">
                    <div class="flashcard-controls">
                        <div class="flashcard-stats">
                            <span>Cards Mastered: <strong id="cards-mastered">0</strong> / <strong id="cards-total">0</strong></span>
                        </div>
                        <div class="form-group">
                            <label for="flashcard-category">Category</label>
                            <select id="flashcard-category" class="form-select">
                                <option value="all">All Categories</option>
                                {% if topics %}
                                {% for topic in topics %}
                                <option value="week-{{ topic.weekNumber }}">Week {{ topic.weekNumber }}: {{ topic.name }}</option>
                                {% endfor %}
                                {% endif %}
                            </select>
                        </div>
                    </div>
                    <div class="flashcard-display">
                        <div id="flashcard" class="flashcard">
                            <div class="flashcard-inner">
                                <div class="flashcard-front"><p id="flashcard-question">Loading flashcards...</p></div>
                                <div class="flashcard-back"><p id="flashcard-answer"></p></div>
                            </div>
                        </div>
                        <div class="flashcard-actions">
                            <button id="prev-card-btn" class="btn btn-secondary" aria-label="Go to previous flashcard">‚Üê Previous</button>
                            <button id="flip-card-btn" class="btn btn-primary" aria-label="Flip flashcard to reveal answer">Flip Card</button>
                            <button id="next-card-btn" class="btn btn-secondary" aria-label="Go to next flashcard">Next ‚Üí</button>
                        </div>
                        <div class="flashcard-knowledge">
                            <button id="know-btn" class="btn btn-success" aria-label="Mark card as known">‚úì I Know This</button>
                            <button id="study-btn" class="btn btn-warning" aria-label="Mark card for further study">‚Üª Need to Study</button>
                        </div>
                    </div>
                </div>
            </section>
            <section id="study-section" class="section">
                <h2 class="section-title">üìö Study Guide</h2>
                <p class="section-description">Generate and view comprehensive study guides from course materials</p>

                <!-- Study Guide Sub-tabs -->
                <div class="quiz-sub-tabs">
                    <button class="quiz-sub-tab active" data-study-tab="saved-guides">üìÇ Saved Guides</button>
                    <button class="quiz-sub-tab" data-study-tab="new-guide">‚ú® Generate New</button>
                </div>

                <!-- Saved Guides Tab -->
                <div id="saved-guides-tab" class="quiz-tab-content active">
                    <div id="study-guides-list" class="saved-quizzes-list">
                        <p class="loading-text">Loading saved study guides...</p>
                    </div>
                </div>

                <!-- Generate New Guide Tab -->
                <div id="new-guide-tab" class="quiz-tab-content" style="display: none;">
                    <div class="study-form">
                        <div class="form-group">
                            <label for="study-week-select">Week (optional):</label>
                            <select id="study-week-select" class="form-control">
                                <option value="">All Weeks</option>
                                <option value="1">Week 1</option>
                                <option value="2">Week 2</option>
                                <option value="3">Week 3</option>
                                <option value="4">Week 4</option>
                                <option value="5">Week 5</option>
                                <option value="6">Week 6</option>
                                <option value="7">Week 7</option>
                            </select>
                            <button type="button" id="estimate-tokens-btn" class="btn btn-small btn-secondary" style="margin-left: 10px;">üìä Estimate Tokens</button>
                        </div>
                        <button id="generate-study-btn" class="btn btn-primary">Generate Comprehensive Study Guide</button>
                    </div>

                    <!-- Collapsible Debug Panel -->
                    <details id="token-debug-panel" class="debug-panel" style="display: none;">
                        <summary>üîß Token Estimation Details</summary>
                        <div id="token-debug-content" class="debug-content">
                            <!-- Populated by JavaScript -->
                        </div>
                    </details>
                </div>

                <!-- Study Guide Content Display -->
                <div id="study-result" class="study-guide-content result-box"></div>
            </section>
        </main>
        <div id="loading" class="loading hidden">
            <div class="spinner"></div>
            <p>Processing...</p>
        </div>
    </div>
    <footer class="footer">
        <p>&copy; 2026 LLS Study Portal | University of Groningen | v{{ version }}</p>
    </footer>
    <script src="/static/js/app.js"></script>
</body>
</html>