<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }} - LLS Admin</title>
    <link rel="icon" type="image/svg+xml" href="/static/images/favicon.svg">
    <link rel="stylesheet" href="/static/css/styles.css?v=8">
    <link rel="stylesheet" href="/static/css/admin.css?v=8">
</head>
<body>
    {% include "admin/partials/dev_mode_banner.html" %}
    <div class="container">
        <header class="nav-header">
            <div class="header-row">
                <h1 class="nav-title">‚öôÔ∏è LLS Admin Portal</h1>
                <div style="display: flex; align-items: center; gap: 1rem;">
                    {% if user %}
                    {% include "admin/partials/user_info.html" %}
                    {% endif %}
                    <a href="/" class="btn btn-secondary">‚Üê Back to Study Portal</a>
                </div>
            </div>
            <div class="nav-tabs">
                <button class="nav-tab active" data-view="courses">üìö Courses</button>
                <a href="/admin/users" class="nav-tab">üë• Users</a>
                <a href="/admin/usage" class="nav-tab">üìä Usage</a>
                <button class="nav-tab" data-view="course-detail" id="course-detail-tab" style="display:none;">üìù Course Details</button>
                <button class="nav-tab" data-view="week-editor" id="week-editor-tab" style="display:none;">üìÖ Week Editor</button>
            </div>
        </header>

        <main id="main-content">
            <!-- Courses List View -->
            <section id="courses-view" class="admin-section active">
                <div class="section-header">
                    <h2 class="section-title">üìö Courses</h2>
                    <div class="header-actions">
                        <button id="import-syllabus-btn" class="btn btn-secondary">üìÑ Import from Syllabus</button>
                        <button id="create-course-btn" class="btn btn-primary">+ New Course</button>
                    </div>
                </div>
                <div id="courses-list" class="courses-grid">
                    <div class="loading-placeholder">Loading courses...</div>
                </div>
            </section>

            <!-- Course Detail View -->
            <section id="course-detail-view" class="admin-section">
                <div class="section-header">
                    <h2 class="section-title">üìù Course Details</h2>
                    <div class="header-actions">
                        <button id="delete-course-detail-btn" class="btn btn-danger" style="margin-right: auto;">üóëÔ∏è Delete Course</button>
                        <button id="back-to-list-btn" class="btn btn-secondary">‚Üê Back to List</button>
                        <button id="save-course-btn" class="btn btn-primary">üíæ Save Changes</button>
                    </div>
                </div>
                <form id="course-form" class="course-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="course-id">Course ID</label>
                            <input type="text" id="course-id" class="form-input" placeholder="e.g., LLS-2025-2026" required>
                        </div>
                        <div class="form-group">
                            <label for="course-name">Course Name</label>
                            <input type="text" id="course-name" class="form-input" placeholder="e.g., Law and Legal Skills" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="course-program">Program</label>
                            <input type="text" id="course-program" class="form-input" placeholder="e.g., Bachelor of Laws">
                        </div>
                        <div class="form-group">
                            <label for="course-institution">Institution</label>
                            <input type="text" id="course-institution" class="form-input" placeholder="e.g., University of Groningen">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="course-year">Academic Year</label>
                            <input type="text" id="course-year" class="form-input" placeholder="e.g., 2025-2026">
                        </div>
                        <div class="form-group">
                            <label for="course-points">ECTS Points</label>
                            <input type="number" id="course-points" class="form-input" placeholder="e.g., 15" min="1" max="60">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="course-subjects">Material Subjects (comma-separated)</label>
                        <input type="text" id="course-subjects" class="form-input" placeholder="e.g., LLS, Criminal_Law">
                        <small class="form-hint">Folder names from Materials/Course_Materials/ (links to file_ids.json)</small>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="course-active" checked> Active
                        </label>
                    </div>
                </form>

                <!-- Components Section -->
                <div class="course-subsection">
                    <div class="section-header">
                        <h3>üß© Course Components</h3>
                        <button id="add-component-btn" class="btn btn-secondary btn-sm">+ Add Component</button>
                    </div>
                    <p class="form-hint">Course parts with points (e.g., Part A: Law - 100 points, Part B: Skills - 100 points)</p>
                    <div id="components-list" class="items-list">
                        <p class="empty-state">No components defined</p>
                    </div>
                </div>

                <!-- Abbreviations Section -->
                <div class="course-subsection">
                    <div class="section-header">
                        <h3>üìö Legal Abbreviations</h3>
                        <button id="add-abbreviation-btn" class="btn btn-secondary btn-sm">+ Add Abbreviation</button>
                    </div>
                    <p class="form-hint">Legal abbreviations and their full names (e.g., GALA ‚Üí General Administrative Law Act)</p>
                    <div id="abbreviations-list" class="items-list">
                        <p class="empty-state">No abbreviations defined</p>
                    </div>
                </div>

                <!-- Text Extraction Dashboard -->
                <div class="course-subsection">
                    <div class="section-header">
                        <h3>üìä Text Extraction Dashboard</h3>
                        <button id="refresh-extraction-stats-btn" class="btn btn-secondary btn-sm">üîÑ Refresh</button>
                    </div>
                    <div id="extraction-dashboard" class="extraction-dashboard">
                        <div class="dashboard-metrics">
                            <div class="metric-card">
                                <div class="metric-value" id="extraction-coverage">--</div>
                                <div class="metric-label">Coverage</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value" id="extraction-total-files">--</div>
                                <div class="metric-label">Total Files</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value" id="extraction-extracted">--</div>
                                <div class="metric-label">Extracted</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value" id="extraction-failed">--</div>
                                <div class="metric-label">Failed</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value" id="extraction-total-chars">--</div>
                                <div class="metric-label">Total Characters</div>
                            </div>
                        </div>
                        <div class="dashboard-breakdown">
                            <h4>üìÅ By File Type</h4>
                            <div id="extraction-by-type" class="type-breakdown">
                                <p class="empty-state">Loading...</p>
                            </div>
                        </div>
                        <div class="dashboard-activity">
                            <h4>üìù Recent Activity</h4>
                            <div id="extraction-activity-log" class="activity-log">
                                <p class="empty-state">No recent activity</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Materials Section -->
                <div class="course-subsection">
                    <div class="section-header">
                        <h3>üìÅ Course Materials</h3>
                        <div class="header-actions">
                            <button id="extract-all-btn" class="btn btn-primary btn-sm">‚ö° Extract All</button>
                            <button id="upload-material-btn" class="btn btn-primary btn-sm">üì§ Upload Files</button>
                            <label class="checkbox-label">
                                <input type="checkbox" id="use-ai-titles"> Use AI for titles
                            </label>
                            <button id="scan-materials-btn" class="btn btn-secondary btn-sm">üîç Scan Folders</button>
                            <button id="sync-week-materials-btn" class="btn btn-secondary btn-sm">üîó Sync to Weeks</button>
                        </div>
                    </div>
                    <p class="form-hint">
                        <strong>Extract All:</strong> Extract text from all materials for LLM processing.<br>
                        <strong>Upload Files:</strong> Upload new documents (PDF, DOCX, images) to course materials.<br>
                        <strong>Scan Folders:</strong> Discovers files from materialSubjects folders.<br>
                        <strong>Sync to Weeks:</strong> Auto-links materials to weeks based on week numbers in filenames.
                    </p>
                    <div id="materials-stats" class="materials-stats hidden"></div>

                    <!-- Bulk Extraction Progress -->
                    <div id="extraction-progress-container" class="extraction-progress-container" style="display: none;">
                        <div class="progress-header">
                            <h4>‚ö° Extracting Text...</h4>
                            <button id="cancel-extraction-btn" class="btn btn-secondary btn-sm">‚úï Cancel</button>
                        </div>
                        <div class="progress-bar-container">
                            <div id="extraction-progress-bar" class="progress-bar"></div>
                        </div>
                        <div class="progress-details">
                            <span id="extraction-progress-text">Processing...</span>
                            <span id="extraction-progress-stats">0 / 0 files</span>
                        </div>
                        <div id="extraction-errors-summary" class="errors-summary" style="display: none;">
                            <p class="error-text">Some files failed to extract. <button id="download-error-report-btn" class="btn-link">Download Error Report</button></p>
                        </div>
                    </div>

                    <div id="course-materials-list" class="materials-list">
                        <p class="empty-state">No materials loaded. Click "Scan Folders" to discover materials or "Upload Files" to add new materials.</p>
                    </div>
                </div>

                <div class="weeks-section">
                    <div class="section-header">
                        <h3>üìÖ Course Weeks</h3>
                        <button id="add-week-btn" class="btn btn-secondary">+ Add Week</button>
                    </div>
                    <div id="weeks-list" class="weeks-grid">
                        <p class="empty-state">No weeks configured. Click "Add Week" to create one.</p>
                    </div>
                </div>
            </section>

            <!-- Week Editor View -->
            <section id="week-editor-view" class="admin-section">
                <div class="section-header">
                    <h2 class="section-title">üìÖ Week Editor</h2>
                    <div class="header-actions">
                        <button id="back-to-course-btn" class="btn btn-secondary">‚Üê Back to Course</button>
                        <button id="save-week-btn" class="btn btn-primary">üíæ Save Week</button>
                    </div>
                </div>
                <form id="week-form" class="week-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="week-number">Week Number</label>
                            <input type="number" id="week-number" class="form-input" min="1" max="52" required>
                        </div>
                        <div class="form-group">
                            <label for="week-title">Week Title</label>
                            <input type="text" id="week-title" class="form-input" placeholder="e.g., Introduction to Criminal Law">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="week-description">Description</label>
                        <textarea id="week-description" class="form-input" rows="3" placeholder="Week overview..."></textarea>
                    </div>
                </form>

                <div class="week-subsection">
                    <h4>üìñ Topics</h4>
                    <div id="topics-list" class="items-list"></div>
                    <button id="add-topic-btn" class="btn btn-secondary btn-sm">+ Add Topic</button>
                </div>

                <div class="week-subsection">
                    <h4>üìö Week Materials</h4>
                    <p class="form-hint">Select from course materials or add custom entries.</p>
                    <div id="week-materials-list" class="items-list"></div>
                    <div class="material-picker">
                        <select id="material-picker-select" class="form-input">
                            <option value="">-- Select a material to add --</option>
                        </select>
                        <button id="add-selected-material-btn" class="btn btn-secondary btn-sm">+ Add Selected</button>
                        <button id="add-custom-material-btn" class="btn btn-secondary btn-sm">+ Add Custom</button>
                    </div>
                </div>

                <div class="week-subsection">
                    <h4>üîë Key Concepts</h4>
                    <div id="concepts-list" class="items-list"></div>
                    <button id="add-concept-btn" class="btn btn-secondary btn-sm">+ Add Concept</button>
                </div>
            </section>
        </main>

        <div id="loading" class="loading hidden">
            <div class="spinner"></div>
            <p>Processing...</p>
        </div>

        <div id="toast" class="toast hidden"></div>

        <!-- Syllabus Import Modal -->
        <div id="syllabus-modal" class="modal hidden">
            <div class="modal-content modal-large">
                <div class="modal-header">
                    <h3>üìÑ Import Course from Syllabus</h3>
                    <button class="modal-close" onclick="closeSyllabusModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <div id="syllabus-step-1">
                        <h4>Step 1: Select a Syllabus PDF</h4>
                        <div id="syllabi-list" class="syllabi-list">
                            <p class="loading-placeholder">Scanning for syllabi...</p>
                        </div>
                    </div>
                    <div id="syllabus-step-2" class="hidden">
                        <h4>Step 2: Review Extracted Data</h4>
                        <p class="form-hint">Review and edit the extracted course information before importing.</p>
                        <div id="extracted-data-preview" class="extracted-preview">
                            <div class="form-group">
                                <label>Course Name</label>
                                <input type="text" id="extracted-name" class="form-input">
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Course Code</label>
                                    <input type="text" id="extracted-code" class="form-input">
                                </div>
                                <div class="form-group">
                                    <label>Academic Year</label>
                                    <input type="text" id="extracted-year" class="form-input">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Program</label>
                                    <input type="text" id="extracted-program" class="form-input">
                                </div>
                                <div class="form-group">
                                    <label>Institution</label>
                                    <input type="text" id="extracted-institution" class="form-input">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Total Points</label>
                                    <input type="number" id="extracted-points" class="form-input">
                                </div>
                                <div class="form-group">
                                    <label>Passing Threshold</label>
                                    <input type="number" id="extracted-threshold" class="form-input">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Material Subjects (comma-separated)</label>
                                <input type="text" id="extracted-subjects" class="form-input" placeholder="e.g., Constitutional Law, Criminal Law, Contracts">
                            </div>
                            <div class="form-group">
                                <label>Weeks Found: <span id="extracted-weeks-count">0</span></label>
                                <div id="extracted-weeks-preview" class="weeks-preview"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button id="syllabus-back-btn" class="btn btn-secondary hidden" onclick="syllabusStepBack()">‚Üê Back</button>
                    <button id="syllabus-extract-btn" class="btn btn-primary hidden" onclick="extractSyllabusData()">Extract Data</button>
                    <button id="syllabus-import-btn" class="btn btn-primary hidden" onclick="importSyllabusData()">Import Course</button>
                </div>
            </div>
        </div>

        <!-- Material Preview Modal -->
        <div id="preview-modal" class="modal hidden">
            <div class="modal-content modal-fullscreen">
                <div class="modal-header">
                    <h3 id="preview-title">üìÑ Material Preview</h3>
                    <button class="modal-close" onclick="closePreviewModal()">&times;</button>
                </div>
                <div class="modal-body preview-body">
                    <iframe id="preview-iframe" class="preview-iframe"></iframe>
                </div>
            </div>
        </div>

        <!-- Upload Material Modal -->
        <div id="upload-modal" class="modal hidden">
            <div class="modal-content modal-large">
                <div class="modal-header">
                    <h3>üì§ Upload Course Materials</h3>
                    <button class="modal-close" onclick="closeUploadModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="upload-form" enctype="multipart/form-data">
                        <div class="form-group">
                            <label for="upload-files">Select Files</label>
                            <div class="file-drop-zone" id="file-drop-zone">
                                <input type="file" id="upload-files" name="files" multiple accept=".pdf,.docx,.pptx,.png,.jpg,.jpeg,.gif,.bmp,.tiff,.webp,.txt,.md,.html,.htm" style="display:none;">
                                <div class="drop-zone-content">
                                    <p class="drop-zone-icon">üìÅ</p>
                                    <p class="drop-zone-text">Drag & drop files here or <button type="button" class="btn-link" onclick="document.getElementById('upload-files').click()">browse</button></p>
                                    <p class="drop-zone-hint">Supported: PDF, DOCX, PPTX, Images, Text files (Max 50MB each)</p>
                                </div>
                                <div id="file-list" class="file-list"></div>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="upload-tier">Material Tier *</label>
                                <select id="upload-tier" class="form-input" required>
                                    <option value="">-- Select Tier --</option>
                                    <option value="syllabus">Syllabus</option>
                                    <option value="course_materials">Course Materials</option>
                                    <option value="supplementary">Supplementary Sources</option>
                                </select>
                            </div>
                            <div class="form-group" id="category-group" style="display:none;">
                                <label for="upload-category">Category</label>
                                <select id="upload-category" class="form-input">
                                    <option value="">-- Select Category --</option>
                                    <option value="lecture">Lecture</option>
                                    <option value="reading">Reading</option>
                                    <option value="case">Case</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="upload-week">Link to Week (Optional)</label>
                            <input type="number" id="upload-week" class="form-input" min="1" max="52" placeholder="e.g., 1">
                        </div>

                        <div class="form-group">
                            <label for="upload-description">Description (Optional)</label>
                            <textarea id="upload-description" class="form-input" rows="3" placeholder="Brief description of the material..."></textarea>
                        </div>

                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="upload-extract-text" checked> Extract text automatically
                            </label>
                            <small class="form-hint">Text extraction enables AI features like quiz generation</small>
                        </div>

                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="upload-generate-summary" checked> Generate AI summary
                            </label>
                            <small class="form-hint">Automatically create a concise summary of the document content</small>
                        </div>

                        <div id="upload-progress" class="upload-progress hidden">
                            <div class="progress-bar">
                                <div class="progress-fill" id="progress-fill"></div>
                            </div>
                            <p class="progress-text" id="progress-text">Uploading...</p>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeUploadModal()">Cancel</button>
                    <button id="upload-submit-btn" class="btn btn-primary" onclick="submitUpload()">üì§ Upload Files</button>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer">
        <p>&copy; 2026 Cognitio Flow Admin | v{{ version }}</p>
    </footer>

    <!-- Text Preview Modal -->
    <div id="text-preview-modal" class="modal hidden">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h3>üìÑ Extracted Text Preview</h3>
                <button class="modal-close" onclick="closeTextPreviewModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="text-preview-metadata">
                    <div class="metadata-row">
                        <span class="metadata-label">File:</span>
                        <span id="preview-file-path" class="metadata-value">--</span>
                    </div>
                    <div class="metadata-row">
                        <span class="metadata-label">File Type:</span>
                        <span id="preview-file-type" class="metadata-value">--</span>
                    </div>
                    <div class="metadata-row">
                        <span class="metadata-label">Extraction Date:</span>
                        <span id="preview-extraction-date" class="metadata-value">--</span>
                    </div>
                    <div class="metadata-row">
                        <span class="metadata-label">Character Count:</span>
                        <span id="preview-char-count" class="metadata-value">--</span>
                    </div>
                    <div class="metadata-row">
                        <span class="metadata-label">Pages:</span>
                        <span id="preview-page-count" class="metadata-value">--</span>
                    </div>
                    <div class="metadata-row">
                        <span class="metadata-label">Extraction Method:</span>
                        <span id="preview-extraction-method" class="metadata-value">--</span>
                    </div>
                </div>
                <div class="text-preview-actions">
                    <button id="copy-text-btn" class="btn btn-secondary btn-sm">üìã Copy to Clipboard</button>
                    <button id="show-full-text-btn" class="btn btn-secondary btn-sm">üìñ Show Full Text</button>
                </div>
                <div class="text-preview-content">
                    <div id="preview-text-container" class="preview-text-container">
                        <p class="empty-state">Loading...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Pass course_id from server if editing specific course
        window.initialCourseId = "{{ course_id | default('') }}";
    </script>
    <script src="/static/js/utils.js?v=9"></script>
    <script src="/static/js/upload.js?v=9"></script>
    <script src="/static/js/admin.js?v=9"></script>
</body>
</html>

